<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.6.0 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Adding group-level predictors in GLMM using lme4 - biologyforfun</title>




<meta name="description" content="Sometime I happen to be wrong, this is one of these instance. The issue: a colleague measured individual plant growth and measured light irradiation received by each individual, the plants where in groups of 10 individuals and he measured soil parameters at the group-level. To analyze the effect of light on plant growth while controlling for soil and group variation, he built a mixed-effect model with group as a random term and light plus soil as fixed effect. As soil was measured at the group-level all individuals within a group got the same soil value.">




<meta name="author" content="Lionel">

<meta property="og:locale" content="en">
<meta property="og:site_name" content="biologyforfun">
<meta property="og:title" content="Adding group-level predictors in GLMM using lme4">


  <link rel="canonical" href="http://localhost:4000/r%20and%20stat/adding-group-level-predictors-in-glmm-using-lme4/">
  <meta property="og:url" content="http://localhost:4000/r%20and%20stat/adding-group-level-predictors-in-glmm-using-lme4/">



  <meta property="og:description" content="Sometime I happen to be wrong, this is one of these instance. The issue: a colleague measured individual plant growth and measured light irradiation received by each individual, the plants where in groups of 10 individuals and he measured soil parameters at the group-level. To analyze the effect of light on plant growth while controlling for soil and group variation, he built a mixed-effect model with group as a random term and light plus soil as fixed effect. As soil was measured at the group-level all individuals within a group got the same soil value.">





  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-06-19T00:00:00+02:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Lionel Hertzog",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>







<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="biologyforfun Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">biologyforfun</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/about/">About</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/research/">Research</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/publications/">Publications</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/blog/">Blog</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/art/">ARt</a></li>
          
        </ul>
        <button type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="http://localhost:4000/assets/images/ID.jpeg" class="author__avatar" alt="Lionel" itemprop="image">
      
    </div>
  

  <div class="author__content">
    <h3 class="author__name" itemprop="name">Lionel</h3>
    
      <p class="author__bio" itemprop="description">
        Ecologist with quasi-pathological addiction for data
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> <span itemprop="name">Gent, Belgium</span>
        </li>
      

      

      
        <li>
          <a href="mailto:lionel.hertzog[a]ugent.be">
            <meta itemprop="email" content="lionel.hertzog[a]ugent.be" />
            <i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/lionel68" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Blog quick-links</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/categories/" class="">Categories</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/tags/" class="">Tags</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Blogroll</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://dynamicecology.wordpress.com/" class="">dynamical ecology</a></li>
          
            
            

            
            

            <li><a href="https://smallpondscience.com/" class="">small pond science</a></li>
          
            
            

            
            

            <li><a href="http://r-bloggers.com/" class="">r-bloggers</a></li>
          
            
            

            
            

            <li><a href="https://scientistseessquirrel.wordpress.com/" class="">scientists see squirel</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Adding group-level predictors in GLMM using lme4">
    <meta itemprop="description" content="Sometime I happen to be wrong, this is one of these instance. The issue: a colleague measured individual plant growth and measured light irradiation received by each individual, the plants where in groups of 10 individuals and he measured soil parameters at the group-level. To analyze the effect of light on plant growth while controlling for soil and group variation, he built a mixed-effect model with group as a random term and light plus soil as fixed effect. As soil was measured at the group-level all individuals within a group got the same soil value.">
    <meta itemprop="datePublished" content="June 19, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Adding group-level predictors in GLMM using lme4
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fa fa-file-text"></i> On This Page</h4></header>
              

            </nav>
          </aside>
        
        <p>Sometime I happen to be wrong, this is one of these instance. The issue: a colleague measured individual plant growth and measured light irradiation received by each individual, the plants where in groups of 10 individuals and he measured soil parameters at the group-level. To analyze the effect of light on plant growth while controlling for soil and group variation, he built a mixed-effect model with group as a random term and light plus soil as fixed effect. As soil was measured at the group-level all individuals within a group got the same soil value.</p>

<p>When he came and asked if what he was doing was correct, I said that he had a classical multilevel dataset and that it was not possible to fit it using lme4, since the model would not know how to differentiate between variation explained by group effects and variation explained by soil effects. Actually this is possible, provided that the variable measured at the group-level is continuous (see <a href="https://biologyforfun.wordpress.com/2015/08/31/two-little-annoying-stats-detail/">this old post</a> on a similar issue), one may add group-level predictors in lme4 fits. Let’s see how it works:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#load libraries</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">lme4</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span><span class="w">

</span><span class="c1">#simulate some data</span><span class="w">

</span><span class="c1">#first case one group-level predictor </span><span class="w">
</span><span class="c1">#and one individual level no interaction</span><span class="w">
  
</span><span class="c1">#group-level predictor</span><span class="w">
</span><span class="n">soil</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">runif</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="m">-2</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="c1">#individual level predictor</span><span class="w">
</span><span class="n">light</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">runif</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="m">-2</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="c1">#group-level regression</span><span class="w">
</span><span class="n">grp_eff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="m">2</span><span class="o">*</span><span class="n">soil</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="c1">#group index</span><span class="w">
</span><span class="n">group</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gl</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w">
</span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">letters</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">])</span><span class="w">
</span><span class="c1">#expected individual values</span><span class="w">
</span><span class="n">linpred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">grp_eff</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="n">light</span><span class="w">
</span><span class="c1">#simulated individual values</span><span class="w">
</span><span class="n">growth</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="n">linpred</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="c1">#putting it together</span><span class="w">
</span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="n">Light</span><span class="o">=</span><span class="n">light</span><span class="p">,</span><span class="w">
</span><span class="n">Soil</span><span class="o">=</span><span class="n">soil</span><span class="p">[</span><span class="n">group</span><span class="p">],</span><span class="n">Growth</span><span class="o">=</span><span class="n">growth</span><span class="p">)</span><span class="w">
  
</span><span class="c1">#model</span><span class="w">
</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">lmer</span><span class="p">(</span><span class="n">Growth</span><span class="o">~</span><span class="n">Light</span><span class="o">+</span><span class="n">Soil</span><span class="o">+</span><span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="n">Group</span><span class="p">),</span><span class="n">dat</span><span class="p">))</span><span class="w">

</span><span class="c1">##Linear mixed model fit by REML ['lmerMod']</span><span class="w">
</span><span class="c1">##Formula: Growth ~ Light + Soil + (1 | Group)</span><span class="w">
</span><span class="c1">## Data: dat</span><span class="w">
</span><span class="c1">##REML criterion at convergence: 608.1304</span><span class="w">
</span><span class="c1">##Random effects:</span><span class="w">
</span><span class="c1">## Groups Name Std.Dev.</span><span class="w">
</span><span class="c1">## Group (Intercept) 0.6773 </span><span class="w">
</span><span class="c1">## Residual 1.0046 </span><span class="w">
</span><span class="c1">##Number of obs: 200, groups: Group, 20</span><span class="w">
</span><span class="c1">##Fixed Effects:</span><span class="w">
</span><span class="c1">##(Intercept) Light Soil </span><span class="w">
</span><span class="c1">## 2.354 2.042 2.122 </span><span class="w">
</span></code></pre></div></div>
<p>The parameter estimates looks pretty good, closed to the values used to simulate the data. It works! One can easily add group-level regression in lme4 provided that the group-level predictor(s) are continuous.
Now we can make nice plots of the group and individual-level regressions.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#gather group-level deviation values </span><span class="w">
</span><span class="c1">#in one dataframe together with deviation</span><span class="w">
</span><span class="n">rf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ranef</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">condVar</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">rff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Group</span><span class="o">=</span><span class="nb">letters</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">],</span><span class="n">Soil</span><span class="o">=</span><span class="n">soil</span><span class="p">,</span><span class="n">RF</span><span class="o">=</span><span class="n">rf</span><span class="o">$</span><span class="n">Group</span><span class="p">[,</span><span class="m">1</span><span class="p">],</span><span class="n">Var</span><span class="o">=</span><span class="nf">attr</span><span class="p">(</span><span class="n">rf</span><span class="o">$</span><span class="n">Group</span><span class="p">,</span><span class="s2">"postVar"</span><span class="p">)[,,</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">])</span><span class="w">
</span><span class="c1">#compute the group level regression</span><span class="w">
</span><span class="n">rff</span><span class="o">$</span><span class="n">RFF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">with</span><span class="p">(</span><span class="n">rff</span><span class="p">,</span><span class="n">RF</span><span class="o">+</span><span class="n">fixef</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="o">*</span><span class="n">Soil</span><span class="p">)</span><span class="w">
</span><span class="c1">#plot</span><span class="w">
</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">rff</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Soil</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">RFF</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">RFF</span><span class="m">-2</span><span class="o">*</span><span class="n">Var</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="n">RFF</span><span class="m">+2</span><span class="o">*</span><span class="n">Var</span><span class="p">))</span><span class="o">+</span><span class="n">geom_point</span><span class="p">()</span><span class="o">+</span><span class="w">
 </span><span class="n">geom_abline</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">intercept</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">slope</span><span class="o">=</span><span class="n">fixef</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="m">2</span><span class="p">]))</span><span class="o">+</span><span class="n">geom_linerange</span><span class="p">()</span><span class="o">+</span><span class="w">
 </span><span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Group-level effect"</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">"Group-level regression"</span><span class="p">)</span><span class="w">

</span><span class="c1">#predict individual-level regression </span><span class="w">
</span><span class="c1">#for average group and average soil</span><span class="w">
</span><span class="n">newdat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">expand.grid</span><span class="p">(</span><span class="n">Light</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="m">20</span><span class="p">),</span><span class="n">Soil</span><span class="o">=</span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="n">newdat</span><span class="o">$</span><span class="n">Pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">newdata</span><span class="o">=</span><span class="n">newdat</span><span class="p">,</span><span class="n">re.form</span><span class="o">=~</span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="c1">#plot</span><span class="w">
</span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Light</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">Growth</span><span class="p">))</span><span class="o">+</span><span class="n">geom_point</span><span class="p">()</span><span class="o">+</span><span class="w">
 </span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">newdat</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Light</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">Pred</span><span class="p">))</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Individual-level regression"</span><span class="p">)</span><span class="w">
    
</span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="n">p</span><span class="m">2</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><a href="https://biologyforfun.wordpress.com/2017/06/19/adding-group-level-predictors-in-glmm-using-lme4/grplvl1/"><img src="https://biologyforfun.files.wordpress.com/2017/06/grplvl1.png" alt="" /></a></p>

<p>A word of caution now on using group-level regressions: I would be very careful (or better avoid) using p-values from such models. The degrees of freedom to test the soil effect are clearly inflated and are hard to guess, so I would advise against significance testing on the group-level regression.
We can of course expand this approach to more complex situation (see some examples <a href="http://onlinelibrary.wiley.com/doi/10.1890/09-1043.1/full">here</a>), let’s see an example where we had an interaction between the group and the individual-level predictors:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#add interaction between group and individual-level </span><span class="w">
</span><span class="c1">#and unbalanced design</span><span class="w">

</span><span class="c1">#group index</span><span class="w">
</span><span class="n">group</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">sample</span><span class="p">(</span><span class="nb">letters</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">],</span><span class="w">
         </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">200</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span><span class="n">grp_eff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="m">2</span><span class="o">*</span><span class="n">soil</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="c1">#expected individual values</span><span class="w">
</span><span class="n">linpred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">grp_eff</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="o">-</span><span class="w">  </span><span class="p">(</span><span class="n">grp_eff</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">light</span><span class="p">)</span><span class="w">
</span><span class="c1">#simulated individual values</span><span class="w">
</span><span class="n">growth</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="n">linpred</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="c1">#putting it together</span><span class="w">
</span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="n">Light</span><span class="o">=</span><span class="n">light</span><span class="p">,</span><span class="w">
       </span><span class="n">Soil</span><span class="o">=</span><span class="n">soil</span><span class="p">[</span><span class="n">group</span><span class="p">],</span><span class="n">Growth</span><span class="o">=</span><span class="n">growth</span><span class="p">)</span><span class="w">

</span><span class="c1">#model</span><span class="w">
</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">lmer</span><span class="p">(</span><span class="n">Growth</span><span class="o">~</span><span class="n">Light</span><span class="o">*</span><span class="n">Soil</span><span class="o">+</span><span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="n">Group</span><span class="p">),</span><span class="n">dat</span><span class="p">))</span><span class="w">
    
    
</span><span class="c1">##    Linear mixed model fit by REML ['lmerMod']</span><span class="w">
</span><span class="c1">##    Formula: Growth ~ Light * Soil + (1 | Group)</span><span class="w">
</span><span class="c1">##       Data: dat</span><span class="w">
</span><span class="c1">##    REML criterion at convergence: 731.4661</span><span class="w">
</span><span class="c1">##    Random effects:</span><span class="w">
</span><span class="c1">##     Groups   Name        Std.Dev.</span><span class="w">
</span><span class="c1">##     Group    (Intercept) 0.5474  </span><span class="w">
</span><span class="c1">##     Residual             1.4182  </span><span class="w">
</span><span class="c1">##    Number of obs: 200, groups:  Group, 20</span><span class="w">
</span><span class="c1">##    Fixed Effects:</span><span class="w">
</span><span class="c1">##    (Intercept)        Light         Soil   Light:Soil  </span><span class="w">
</span><span class="c1">##          2.138        1.961        1.844       -1.865  </span><span class="w">
</span></code></pre></div></div>
<p>This is where it starts to get tricky for me, the estimate of the interaction between group and individual-level predictors is twice as big as the simulated value. Maybe I am doing something wrong in the simulation part …
Anyhow we can still do some cool plots:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#group-level plot</span><span class="w">
</span><span class="n">rf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ranef</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">condVar</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">rff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Group</span><span class="o">=</span><span class="nb">letters</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">],</span><span class="n">Soil</span><span class="o">=</span><span class="n">soil</span><span class="p">,</span><span class="n">RF</span><span class="o">=</span><span class="n">rf</span><span class="o">$</span><span class="n">Group</span><span class="p">[,</span><span class="m">1</span><span class="p">],</span><span class="n">Var</span><span class="o">=</span><span class="nf">attr</span><span class="p">(</span><span class="n">rf</span><span class="o">$</span><span class="n">Group</span><span class="p">,</span><span class="s2">"postVar"</span><span class="p">)[,,</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">])</span><span class="w">
</span><span class="c1">#compute the group level regression</span><span class="w">
</span><span class="n">rff</span><span class="o">$</span><span class="n">RFF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">with</span><span class="p">(</span><span class="n">rff</span><span class="p">,</span><span class="n">RF</span><span class="m">+2.16</span><span class="o">*</span><span class="n">Soil</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">rff</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Soil</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">RFF</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">RFF</span><span class="m">-2</span><span class="o">*</span><span class="n">Var</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="n">RFF</span><span class="m">+2</span><span class="o">*</span><span class="n">Var</span><span class="p">))</span><span class="o">+</span><span class="n">geom_point</span><span class="p">()</span><span class="o">+</span><span class="w">
  </span><span class="n">geom_abline</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">intercept</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">slope</span><span class="o">=</span><span class="m">2.16</span><span class="p">))</span><span class="o">+</span><span class="n">geom_linerange</span><span class="p">()</span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Group-level effect"</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">"Group-level regression"</span><span class="p">)</span><span class="w">

</span><span class="c1">#predict individual effect for average group and average soil</span><span class="w">
</span><span class="n">newdat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">expand.grid</span><span class="p">(</span><span class="n">Light</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="m">20</span><span class="p">),</span><span class="n">Soil</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">newdat</span><span class="o">$</span><span class="n">Pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">newdata</span><span class="o">=</span><span class="n">newdat</span><span class="p">,</span><span class="n">re.form</span><span class="o">=~</span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Light</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">Growth</span><span class="p">))</span><span class="o">+</span><span class="n">geom_point</span><span class="p">()</span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">newdat</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Light</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">Pred</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">factor</span><span class="p">(</span><span class="n">Soil</span><span class="p">)))</span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Individual-level regression"</span><span class="p">)</span><span class="o">+</span><span class="w">
  </span><span class="n">scale_color_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Soil"</span><span class="p">)</span><span class="w">
  
</span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="n">p</span><span class="m">2</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><a href="https://biologyforfun.wordpress.com/2017/06/19/adding-group-level-predictors-in-glmm-using-lme4/grplvl2/"><img src="https://biologyforfun.files.wordpress.com/2017/06/grplvl2.png" alt="" /></a></p>

<p>That’s it, one does not need to use more complex modelling technique like maximum likelihood estimation or multilevel bayesian regression, one can use rather straightforward lme4 fits for exploring group-level regressions. 
A must-read for anyone interested in hierarchical/multilevel models is the <a href="http://www.stat.columbia.edu/~gelman/arm/">Gelman and Hill book</a>.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#lme4" class="page__taxonomy-item" rel="tag">lme4</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#multilevel" class="page__taxonomy-item" rel="tag">multilevel</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#nr" class="page__taxonomy-item" rel="tag">nR</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#r" class="page__taxonomy-item" rel="tag">R</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/categories/#r-and-stat" class="page__taxonomy-item" rel="tag">R and Stat</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-06-19T00:00:00+02:00">June 19, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Adding+group-level+predictors+in+GLMM+using+lme4%20http%3A%2F%2Flocalhost%3A4000%2Fr%2520and%2520stat%2Fadding-group-level-predictors-in-glmm-using-lme4%2F" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fr%2520and%2520stat%2Fadding-group-level-predictors-in-glmm-using-lme4%2F" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fr%2520and%2520stat%2Fadding-group-level-predictors-in-glmm-using-lme4%2F" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fr%2520and%2520stat%2Fadding-group-level-predictors-in-glmm-using-lme4%2F" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/opinion%20posts/on-the-price-of-my-higher-education/" class="pagination--pager" title="On the price of (my) higher education
">Previous</a>
    
    
      <a href="http://localhost:4000/biological%20stuff/opinion%20posts/cause-mechanism-and-prediction-in-ecology/" class="pagination--pager" title="Cause, mechanism and prediction in ecology
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a Comment</h4>
      <section id="disqus_thread"></section>
    
</div>
    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/tease.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/biological%20stuff/r%20and%20stat/simulation-sem-2/" rel="permalink">Simulating SEMs: part 2 extensions
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Back in May I published a first post which simulated simple Structural Equation Models (SEMs) to check the capacity of piecewieseSEM to deal with noise. At t...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/tease.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/r%20and%20stat/catgorical-random-effects-with-lme4/" rel="permalink">Categorical random effects with lme4
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  10 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">The aim of this post is to see how to fit mixed effect models with varying effects when the explanatory variable that varies is a categorical variables. For ...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/tease.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/biological%20stuff/opinion%20posts/mind-the-gap-when-the-news-article-run-ahead-of-the-science/" rel="permalink">Mind the gap: when the news article run ahead of the science
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">This is a quick post on a blatant example on how careful and prudent interpretation in scientific articles are over-simplified in news article.

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/tease.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/r%20and%20stat/three-way-interactions-in-r/" rel="permalink">Interpreting three-way interactions in R
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  4 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">A reader asked in a comment to my post on interpreting two-way interactions if I could also explain interaction between two categorical variables and one con...</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>


    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="http://github.com/lionel68"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 Lionel Hertzog. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>





    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/r%20and%20stat/adding-group-level-predictors-in-glmm-using-lme4/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/r%20and%20stat/adding-group-level-predictors-in-glmm-using-lme4"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://https-lionel68-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>